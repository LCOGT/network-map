<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Las Cumbres Observatory Global Telescope Network</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@700&family=Libre+Franklin:ital,wght@0,400;0,700;1,500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href='/css/map.css' />
  <link rel="stylesheet" href='/css/all.min.css' />
  <style>
html,body { height: 100%; }
body {
  padding: 0px;
  margin: 0px;
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family:"Libre Franklin",Arial,sans-serif;
}
</style>
</head>

<body>
  <div id="map"></div>
  <div class="aspect-ratio-box">
  <div class="worldMap">
    <div class="mapText" style="visibility:hidden;">
      Las Cumbres Observatory<br/>
      Global Telescope Network
    </div>
    <div class="location tlv" data-location="tlv">
    <div class="weather">
    </div>
    <div class="infoBox">
      <div class="telescopes">
        <img src="/imgs/1m0.png" class="t1m0" />
      </div>
      <div class="content">
        <p class="info-header">Wise Observatory</p>
        <p>South District, Israel</p>
        <p>1 x 1-meter (NRES only)</p>
      </div>
    </div>
    </div>
    <div class="location lsc" data-location="lsc">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="telescopes">
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/0m4.png" class="t0m4" />
          <img src="/imgs/0m4.png" class="t0m4" />
        </div>
        <div class="content">
          <p class="info-header">Cerro Tololo Observatory</p>
          <p>District IV, Chile</p>
          <p>3 x 1-meter</p>
          <p>2 x 0.4-meter</p>
        </div>
      </div>
    </div>
    <div class="location sba" data-location="sba">
      <div class="infoBox">
        <p class="info-header">Goleta</p>
        <p>California</p>
        <p>International Headquarters and Data Center</p>
      </div>
    </div>
    <div class="location uk" data-location="uk">
      <div class="infoBox">
          <p class="info-header">United Kingdom</p>
          <p><em>Chester</em> - European Operations Center</p>
          <p><em>Cardiff</em> - Education Headquarters</p>
      </div>
    </div>
    <div class="location ngq" data-location="ngq">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="content">
          <p class="info-header">Ali Observatory</p>
          <p>Western Tibet, China</p>
          <p>Site under development</p>
        </div>
      </div>
    </div>
    <div class="location ogg" data-location="ogg">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="telescopes">
          <img src="/imgs/2m0.png" class="t2m0" />
          <img src="/imgs/0m4.png" class="t0m4" />
          <img src="/imgs/0m4.png" class="t0m4" />
        </div>
        <div class="content">
          <p class="info-header">Haleakala Observatory</p>
          <p>Maui, Hawaii</p>
          <p>1 x 2-meter</p>
          <p>2 x 0.4-meter</p>
        </div>
      </div>
    </div>
    <div class="location elp" data-location="elp">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="telescopes">
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/0m4.png" class="t0m4" />
        </div>
        <div class="content">
          <p class="info-header">McDonald Observatory</p>
          <p>Fort Davis, Texas</p>
          <p>2 x 1-meter</p>
          <p>1 x 0.4-meter</p>
        </div>
      </div>
    </div>
    <div class="location tfn" data-location="tfn">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="telescopes">
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/0m4.png" class="t0m4" />
          <img src="/imgs/0m4.png" class="t0m4" />
        </div>
        <div class="content">
          <p class="info-header">Teide Observatory</p>
          <p>Tenerife, Canary Islands, Spain</p>
          <p>2 x 0.4-meter</p>
          <p>2 x 1-meter</p>
        </div>
      </div>
    </div>
    <div class="location cpt" data-location="cpt">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="telescopes">
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/0m4.png" class="t0m4" />
        </div>
        <div class="content">
          <p class="info-header">South African Astronomical Observatory</p>
          <p>Sutherland, South Africa</p>
          <p>3 x 1-meter</p>
          <p>1 x 0.4-meter</p>
        </div>
      </div>
    </div>
    <div class="location coj" data-location="coj">
      <div class="weather">
      </div>
      <div class="infoBox">
        <div class="telescopes">
          <img src="/imgs/2m0.png" class="t2m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/1m0.png" class="t1m0" />
          <img src="/imgs/0m4.png" class="t0m4" />
          <img src="/imgs/0m4.png" class="t0m4" />
        </div>
        <div class="content">
          <p class="info-header">Siding Spring Observatory</p>
          <p>New South Wales, Australia</p>
          <p>1 x 2-meter</p>
          <p>2 x 1-meter</p>
          <p>2 x 0.4-meter</p>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script type="module" src="suncalc.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    var urlParams = new URLSearchParams(window.location.search);
    var maptext = document.querySelector('.mapText');
    if (urlParams.get('light') != null){
      var elem = document.querySelector('.aspect-ratio-box');
      elem.style.backgroundImage = "url('imgs/networkmap-white-01.svg')";
    }
    if (urlParams.get('noident') != null){
      maptext.style.visibility = "hidden";
    } else {
      maptext.style.visibility = "visible";
    }

  var sitecodes  = {
    'elp': {
      "weather": {
			  "current": "NOT_OK_TO_OPEN",
  			"day": false,
      },
      "lat": 30.679,
      "lng": -104.015,
		},
    'tfn': {
      "weather": {
        "current": "NOT_OK_TO_OPEN",
        "day": false,
      },
      "lat": 28.30,
      "lng": -16.511,
    },
    'cpt': {
      "weather": {
        "current": "NOT_OK_TO_OPEN",
        "day": false,
      },
      "lat": -32.380,
      "lng": 20.81,
    },
    'tlv': {
      "weather": {
        "current": "NOT_OK_TO_OPEN",
        "day": false,
      },
      "lat": 28.30,
  		"lng": -16.511,
    },
    'coj': {
      "weather": {
        "current": "NOT_OK_TO_OPEN",
        "day": false,
      },
      "lat": -31.272,
      "lng": 149.07,
    },
    'ogg': {
      "weather": {
        "current": "NOT_OK_TO_OPEN",
        "day": false,
      },
      "lat": 20.706,
      "lng": -156.258,
    },
    'lsc': {
      "weather": {
        "current": "NOT_OK_TO_OPEN",
        "day": false,
      },
      "lat": -30.167,
      "lng": -70.804,
    },
  }

  async function weather() {
    var tmparr = sitecodes;
    var now = new Date();
    var end = now.toISOString();
    now.setDate(now.getDate()-1);
    var start = now.toISOString();
    for (var site in sitecodes){
      var position = SunCalc.getPosition(now, sitecodes[site]['lat'], sitecodes[site]['lng']);
      tmparr[site]['weather']['day'] = (position.altitude < 0) ? false : true;
      state = await checkWeather(site, start, end);
      tmparr[site]['weather']['current'] =  state['state'];
    }
    updateWeatherIcons(tmparr)

  }
  function checkWeather(site,start,end) {
    return axios.get('https://weather-api.lco.global/query?site='+site+'&datumname=Weather%20Ok%20To%20Open&agg=False&start='+start+'&end='+end)
      .then(response => response.data)
      .then(json => {
        if (json!=null){
          var state = json[json.length-1]['ValueString']=='true' ? true : false;
        }else{
          var state = false;
        }
        return {'state':state, 'site':site}
    });
  }
  function updateWeatherIcons(sites){
    for (var site in sites){
      var elem = document.querySelector('.'+site+' .weather');
      if (sites[site]['weather']['day'] == true  && sites[site]['weather']['current'] == true ){
        elem.innerHTML = '<i class="fas fa-sun"></i></span>';
      } else if (sites[site]['weather']['day'] == true && sites[site]['weather']['current'] == false){
        elem.innerHTML = '<i class="fad fa-clouds-sun"></i></span>';
      } else if (sites[site]['weather']['day'] == false && sites[site]['weather']['current'] == true){
        elem.innerHTML = '<i class="fas fa-stars"></i>';
      } else if (sites[site]['weather']['day'] == false && sites[site]['weather']['current'] == false){
        elem.innerHTML = '<i class="fas fa-clouds"></i>';
      } else {
        console.log('Error with '+site+" "+sites[site]['weather']['day']+" "+sites[site]['weather']['current']);
      }
    }
  }

  if (urlParams.get('weather') != null){
    console.log('weather set')
    var timer = setInterval(function(){
          Promise.all([weather()])
        },2000);
  } else {
    console.log('weather not set')
  }
  </script>
</body>

</html>
